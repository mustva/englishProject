@using System.Globalization
@using System.ServiceModel
@using englishProject.Infrastructure
@using englishProject.Infrastructure.ViewModel
@using englishProject.Models
@using Newtonsoft.Json
@{
    ViewBag.Title = "levelExam";
    Layout = "~/Views/Shared/_LayoutExam.cshtml";

    Level level = ViewBag.level;
    Modul m = ViewBag.modul;
    HtmlString exam = null;

    switch (m)
    {
        case Modul.WordModul:
            exam = Html.HtmlConvertToJson((WordModul)ViewBag.exam);
            break;
        case Modul.PictureWordModul:
            exam = Html.HtmlConvertToJson((PictureWordModul)ViewBag.exam);
            break;
    }

}
@section scripts
{

    <script src="@Url.Content("~/Scripts/Modul/commonModul.js")"></script>
    <script src="@Url.Content("~/Scripts/Modul/" + m.ToString() + ".js")"></script>

    <script type="text/javascript">
        ko.bindingHandlers.executeOnEnter = {
            init: function (element, valueAccessor, allBindings, viewModel) {
                var callback = valueAccessor();
                $(element).keypress(function (event) {
                    var keyCode = (event.which ? event.which : event.keyCode);
                    if (keyCode === 13) {
                        callback.call(viewModel);
                        return false;
                    }
                    return true;
                });
            }
        }

        var commentIssueViewModel=function() {
            var self = this;
            self.loading = ko.observable(false);
            self.resultText =ko.observable("Mesajınız gönderilmiştir.");

            self.viewModel= {
                CommentIssue:ko.observable(),
                ExceptId:parseInt("@level.levelId"),
                Kind:ko.observable("1"),
                UserId:"@Operations.GetUserId"
            }

            self.viewModel.Kind.subscribe(function(newValue) {

                console.log(newValue);
                if (newValue == "1") {
                    self.resultText("Mesajınız gönderilmiştir.");
                }
                if(newValue=="2") {
                    self.resultText("Sorununuz bildirilmiştir.");
                }

            });

            self.send=function() {

                if ($("#commentIssueForm").valid()) {
                    self.loading(true);
                    var jsonData = ko.toJSON(self.viewModel);
                    console.log(jsonData);

                    $.ajax("/api/ajax/CommentIssueSave", {
                        type: "POST",
                        data: jsonData,
                        contentType: "application/json",
                        success: function (data) {

                            if (data) {

                                setTimeout(function() {
                                    $("#commentIssueModal").modal("hide");
                                }, 2000);

                            } else {
                                self.resultText("@HelperMethod.GetErrorMessage");
                            }
                        },
                        complete:function() {
                            self.loading(false);
                            $("#result").show();
                        }
                    });

                }

                return false;
            }

        }

        $(document).ready(function () {

            var commentVM = new commentIssueViewModel();
            ko.applyBindings(commentVM,document.getElementById("commentIssueModal"));
            var  vm = new viewmodel(@exam, @level.levelId,@level.levelSubLevel,@level.boxId);
            ko.applyBindings(vm, document.getElementById("examWrapper"));

            $('[data-toggle="tooltip"]').tooltip();
            $('[data-toggle="popover"]').popover('show');

            $("#loading").modal({ backdrop: false });
            $(window).load(function () {
                $("#loading").modal("hide");

            });
            $("#btnCommentIssue,#btnCommentIssue2").click(function() {
                $("#commentIssueModal").modal();
                $("#result").hide();
                $("#CommentIssue").val("");

            });

        });
    </script>
}
@Html.Partial("ModulPartial/LoadingPartial")

@Html.Partial("Modul/" + m.ToString())

@Html.Partial("ModulPartial/CommentIssue", new CommentIssueVM() { ExceptId = level.levelId })